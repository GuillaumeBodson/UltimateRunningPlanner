@page "/"
@using WebUI.Components.Standalone.AthleteManagement
@using WebUI.Models
@using WebUI.Services.Interfaces
@inject ISession<Athlete> AthleteSession
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>Athlete</PageTitle>
<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    <MudText Typo="Typo.h3" Color="Color.Primary" Class="page-title mb-3">Athlete Management</MudText>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <MudTabPanel Text="Performances">
            <AthletePerformancesComponent Performances="_athlete.Performances"
                                          PerformancesChanged="OnPerformancesChanged" 
                                          OnPaceFetched="OnPaceFetched"/>
        </MudTabPanel>

        <MudTabPanel Text="Paces">
            <AthletePaceComponent AthleteCreation="_athleteCreation"
                                  AthleteCreationChanged="OnAthleteCreationChanged" />
        </MudTabPanel>

        <MudTabPanel Text="Training Templates">
            <TemplateCreationComponent TrainingTemplates="_athlete.TrainingTemplates"
                                       TrainingTemplatesChanged="OnTrainingTemplatesChanged" />
        </MudTabPanel>
    </MudTabs>

    <MudStack Row="true" Class="mt-4" Spacing="2" AlignItems="AlignItems.Center">
        <MudButton Color="Color.Primary" Variant="Variant.Filled"
                   OnClick="SaveAthleteAsync" StartIcon="@Icons.Material.Filled.Save">
            Save Athlete
        </MudButton>
        <MudButton Variant="Variant.Outlined" OnClick="ResetAsync"
                   StartIcon="@Icons.Material.Filled.Restore">
            Reset
        </MudButton>
        <MudSpacer />
        <MudButton Color="Color.Error" Variant="Variant.Outlined"
                   OnClick="ClearStorageAsync" StartIcon="@Icons.Material.Filled.DeleteForever">
            Clear Stored Data
        </MudButton>
    </MudStack>
</MudContainer>

@code {
    private Athlete _athlete = new();
    private AthleteCreation _athleteCreation = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var fromStorage = await AthleteSession.GetAsync();
            if (fromStorage is not null)
            {
                _athlete = fromStorage;
                _athlete.Performances ??= new();
                _athleteCreation = new AthleteCreation(_athlete);
            }
            else
            {
                _athlete.Performances ??= new();
            }
            StateHasChanged();
        }
    }

    private void OnAthleteCreationChanged(AthleteCreation updatedCreation)
    {
        _athleteCreation = updatedCreation;
        // Update athlete paces immediately for real-time sync
        var tempAthlete = _athleteCreation.ToAthlete();
        _athlete.EasyPace = tempAthlete.EasyPace;
        _athlete.MarathonPace = tempAthlete.MarathonPace;
        _athlete.SemiMarathonPace = tempAthlete.SemiMarathonPace;
        _athlete.TenKPace = tempAthlete.TenKPace;
        _athlete.FiveKPace = tempAthlete.FiveKPace;
        _athlete.MasPace = tempAthlete.MasPace;
    }

    private void OnPerformancesChanged(List<Performance> updated)
    {
        // Keep as List<Performance> for storage
        _athlete.Performances = updated;
		SyncPacesWithPerformances(updated);

        StateHasChanged();
    }

    private void OnTrainingTemplatesChanged()
    {
        // Templates are modified directly on _athlete.TrainingTemplates
        // This callback just triggers UI refresh if needed
        StateHasChanged();
    }

    private async Task SaveAthleteAsync()
    {
        await AthleteSession.SetAsync(_athlete);
        Snackbar.Add("Athlete saved successfully", Severity.Success);
    }

    private async Task ResetAsync()
    {
        var fromStorage = await AthleteSession.GetAsync();
        _athlete = fromStorage ?? new Athlete();
        _athlete.Performances ??= new();
        _athleteCreation = new AthleteCreation(_athlete);
        Snackbar.Add("Form reset", Severity.Info);
        StateHasChanged();
    }

    private async Task ClearStorageAsync()
    {
        await AthleteSession.ClearAsync();
        _athlete = new Athlete();
        _athlete.Performances = new();
        _athleteCreation = new AthleteCreation();
        Snackbar.Add("Stored data cleared", Severity.Warning);
        StateHasChanged();
    }
    private void UpdatePace(Action<Athlete, Pace> athleteSetter, Action<AthleteCreation, double> athleteCreationSetter, Pace pace)
    {
        athleteSetter(_athlete, pace);
        athleteCreationSetter(_athleteCreation, pace.ToMinutesDotSeconds());
    }

    private void OnPaceFetched(MultiplePerformancesPrediction args)
    {
        _athlete.EnduranceIndex = args.RiegelParameters;
        
        SyncPacesWithPerformances([.. args.Predictions]);
    }

    private void SyncPacesWithPerformances(IEnumerable<IPerformance> performances)
    {
        foreach (var performance in performances)
        {
            switch (performance.Distance)
            {
                case 2_000:
                    UpdatePace((a, p) => a.MasPace = p, (ac, v) => ac.MasPace = v, performance.Pace);
                    break;
                case 5_000:
                    UpdatePace((a, p) => a.FiveKPace = p, (ac, v) => ac.FiveKPace = v, performance.Pace);
                    break;
                case 10_000:
                    UpdatePace((a, p) => a.TenKPace = p, (ac, v) => ac.TenKPace = v, performance.Pace);
                    break;
                case 21_097:
                    UpdatePace((a, p) => a.SemiMarathonPace = p, (ac, v) => ac.SemiMarathonPace = v, performance.Pace);
                    break;
                case 42_195:
                    UpdatePace((a, p) => a.MarathonPace = p, (ac, v) => ac.MarathonPace = v, performance.Pace);
                    break;
                case 500_000:
                    UpdatePace((a, p) => a.EasyPace = p, (ac, v) => ac.EasyPace = v, performance.Pace);
                    break;
            }
        }
    }
}