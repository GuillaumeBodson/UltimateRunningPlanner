@page "/calendar"
@rendermode InteractiveServer
@using System.Collections.ObjectModel
@using System.MudPlanner
@using BlazorApp.Components
@using BlazorLibraries.MudPlanner
@using GarminRunerz.Workout.Services.Models
@using Toolbox.Utilities
@using WebUI.Components.WorkoutTemplates
@using WebUI.Mappers
@using WebUI.Models
@using WebUI.Models.Workouts
@using WebUI.Services
@using WebUI.Services.Interfaces
@using static WebUI.Models.Planning.RemovalResult
@inject ISession<Athlete> AthleteSession
@inject IDialogService Dialog
@inject IPlannedWorkoutFactory WorkoutCreator
@inject ISnackbar Snackbar
@inject ILogger<CalendarPage> Logger
@inject ISession<Planning> PlanningSession
@inject IWorkoutTemplateSelector TemplateSelector


<PageTitle>Calendar</PageTitle>
<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    <MudText Typo="Typo.h3" Color="Color.Primary" Class="page-title mb-3">Calendar</MudText>

    <CalendarComponent @bind-Planning="CalendarEvents" @bind-WeekRecaps="WeekRecaps" HasWeekRecap="true"
                       @ref="_calendar"
                       OnPlanningSaveCallback="PlanningSave"
                       CreateEventAsync="CreateEventAsync"
                       RemoveEventAsync="RemoveEventAsync" >
        <SelectedEventTemplate Context="ev">

            @{
                var workout = _planning?.Workouts.FirstOrDefault(w => w.Id == ev.Id);
                var componentType = workout is not null
                ? TemplateSelector.Select(workout)
                : typeof(GenericWorkoutTemplate);

                var parameters = new Dictionary<string, object?>
                {
                    ["Event"] = ev,
                    ["Workout"] = workout,
                    ["Athlete"] = _athlete
                };
            }

            <DynamicComponent Type="componentType" Parameters="parameters" />

            <MudStack Spacing="1">

                <MudStack Row="true" Spacing="1">
                    <MudButton Color="Color.Error" Variant="Variant.Outlined"
                               OnClick="@(async () => await _calendar?.RemoveEventAndCloseAsync(ev))">
                        Delete
                    </MudButton>
                </MudStack>
            </MudStack>
        </SelectedEventTemplate>
    </CalendarComponent>

</MudContainer>


@code {
    public ObservableCollection<CalendarEvent>? CalendarEvents { get; set; } = [];
    public ObservableCollection<WeekRecap> WeekRecaps { get; set; } = [];
    private Planning? _planning;
    private Athlete? _athlete;
    private BlazorLibraries.MudPlanner.CalendarComponent? _calendar;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        _planning = await PlanningSession.GetAsync();
        _athlete = await AthleteSession.GetAsync();

        if (_planning is null)
        {
            CalendarEvents = [];
        }
        else
        {
            WeekRecaps.AddRange(_planning.WeeksRecap);
            CalendarEvents!.AddRange(_planning.CalendarEvents);
        }
        StateHasChanged();
    }

    private async Task PlanningSave((DateOnly date, CalendarEvent ev) args)
    {
        if (_planning is null)
        {
            Snackbar.Add("No planning loaded. Cannot save workout changes.", Severity.Error);
            return;
        }

        var weekNumber = _planning.GetWeekNumber(args.ev.Date);

        var plannedWorkout = _planning.Workouts.FirstOrDefault(w => w.Id == args.ev.Id);

        if (plannedWorkout is null)
        {
            Snackbar.Add($"Workout with ID {args.ev.Id} not found in planning.", Severity.Error);
            return;
        }

        plannedWorkout.WeekNumber = weekNumber;
        plannedWorkout.Date = args.ev.Date;

        await PlanningSession.SetAsync(_planning);
    }

    private async Task<CalendarEvent?> CreateEventAsync(DateOnly date)
    {
        try
        {
            // Ensure planning is loaded
            if (_planning is null)
            {
                Snackbar.Add("No planning loaded. Please build or load a planning first.", Severity.Error);
                return null;
            }

            if (_athlete is null)
            {
                Snackbar.Add("No athlete data found. Cannot create workout.", Severity.Error);
                return null;
            }

            int weekNumber;
            try
            {
                weekNumber = _planning.GetWeekNumber(date);
            }
            catch (ArgumentOutOfRangeException ex)
            {
                Snackbar.Add(ex.Message, Severity.Warning);
                Logger.LogWarning(ex, "CreateEventAsync rejected date {Date}", date);
                return null;
            }

            var model = await OpenDialogAsync(date);
            if (model is null) return null;

            // Safe ID generation (aligned with PlanningBuilder seed logic)
            var id = NextIdForWeek(weekNumber);

            // Map + add to BaseWorkouts and Workouts
            var workout = model.ToWorkoutDto(weekNumber, _athlete, id);

            var planned = WorkoutCreator.Create(workout, _athlete, date);
            _planning.Workouts.Add(planned);

            // Persist planning
            await PlanningSession.SetAsync(_planning);

            StateHasChanged();
            Snackbar.Add("Event created", Severity.Success);

            return planned.ToCalendarEvent();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "CreateEventAsync failed for date {Date}", date);
            Snackbar.Add("Failed to create event. See logs for details.", Severity.Error);
            return null;
        }
    }

    private int NextIdForWeek(int weekNumber)
    {
        // Base seed consistent with PlanningBuilder: (week + 9) * 100
        var baseSeed = (weekNumber + 9) * 100;
        var maxIdInWeek = _planning!.Workouts
            .Where(w => w.WeekNumber == weekNumber)
            .Select(w => w.Id)
            .DefaultIfEmpty(baseSeed - 1) // ensures at least baseSeed on first insert
            .Max();

        // Ensure monotonic increase and keep inside the week’s ID band
        return Math.Max(maxIdInWeek + 1, baseSeed);
    }

    private async Task<CustomWorkoutModel?> OpenDialogAsync(DateOnly date)
    {
        // Open dialog to collect workout data
        var parameters = new DialogParameters<WorkoutCreationDialog>
        {
            [nameof(WorkoutCreationDialog.Date)] = date
        };

        var options = new DialogOptions { CloseButton = true, FullWidth = true };
        var dialog = await Dialog.ShowAsync<WorkoutCreationDialog>("Create workout", parameters, options);
        var result = await dialog.Result;

        if (result is null || result.Canceled || result.Data is not CustomWorkoutModel model)
            return null;

        return model;
    }
    
    private async Task RemoveEventAsync(int id)
    {
        if (_planning is null || CalendarEvents is null)
        {
            Snackbar.Add("No planning loaded. Cannot remove workout.", Severity.Error);
            return;
        }

        var result = _planning.RemoveWorkoutById(id);

        if (!result.Success)
        {
            var severity = result.FailureReason switch
            {
                RemovalFailureReason.PlanningNotLoaded => Severity.Warning,
                RemovalFailureReason.WorkoutNotFound => Severity.Warning,
                _ => Severity.Error
            };

            Snackbar.Add(result.ErrorMessage!, severity);
            return;
        }

        // Persist updated planning
        await PlanningSession.SetAsync(_planning);
        // Update UI state
        CalendarEvents.Remove(CalendarEvents.First(e => e.Id == id));

        Snackbar.Add("Workout removed successfully", Severity.Success);
        StateHasChanged();
    }
}