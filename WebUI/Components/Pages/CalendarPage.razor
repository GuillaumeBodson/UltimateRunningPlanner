@page "/calendar"
@rendermode InteractiveServer

@using System.Collections.ObjectModel
@using System.MudPlanner
@using BlazorApp.Components
@using BlazorLibraries.MudPlanner
@using GarminRunerz.Workout.Services.Models
@using Toolbox.Utilities
@using WebUI.Mappers
@using WebUI.Models
@using WebUI.Models.Workouts
@using WebUI.Services
@using WebUI.Services.Interfaces
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject IAthleteSession AthleteSession
@inject IDialogService Dialog
@inject IPlannedWorkoutFactory WorkoutCreator;

<PageTitle>Calendar</PageTitle>
<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    <MudText Typo="Typo.h3" Color="Color.Primary" Class="page-title mb-3">Calendar</MudText>

    <CalendarComponent @bind-Planning="CalendarEvents" @bind-WeekRecaps="WeekRecaps" HasWeekRecap="true"
                       OnPlanningSaveCallback="PlanningSave" 
                       CreateEventAsync="CreateEventAsync"/>

</MudContainer>


@code {
    public ObservableCollection<CalendarEvent>? CalendarEvents { get; set; } = [];
    public ObservableCollection<WeekRecap> WeekRecaps { get; set; } = [];
    private List<CustomWorkout>? _workouts;
    private Planning? _planning;
    private DateOnly _planningStartDate;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        _planningStartDate = await localStorage.GetItemAsync<DateOnly>(Constants.StartDateKey);
        _planning = await localStorage.GetItemAsync<Planning>(Constants.PlanningKey);

        var athlete = await AthleteSession.GetAndSetAsync();

        if (_planning is null)
        {
            CalendarEvents = [];
        }
        else
        {
            WeekRecaps.AddRange(_planning.WeeksRecap);
            CalendarEvents!.AddRange(_planning.CalendarEvents);
        }
        StateHasChanged();
    }

    // To move
    private int GetWeekNumber(DateOnly eventDate)
    {
        if (eventDate < _planningStartDate)
            throw new ArgumentOutOfRangeException(nameof(eventDate), "eventDate cannot be before startDate.");

        int daysDifference = eventDate.DayNumber - _planningStartDate.DayNumber;
        return (daysDifference / 7) + 1;
    }
    private async void PlanningSave((DateOnly date, CalendarEvent ev) args)
    {
        var workout = _planning.BaseWorkouts!.FirstOrDefault(w => w.Id == args.ev.Id);
        var weekNumber = GetWeekNumber(args.ev.Date);
        workout!.WeekNumber = weekNumber;

        var plannedWorkout = _planning.Workouts.FirstOrDefault(w => w.Id == args.ev.Id);
        plannedWorkout!.WeekNumber = weekNumber;
        plannedWorkout.Date = args.ev.Date;

        await localStorage.SetItemAsync(Constants.PlanningKey, _planning);
    }
    private async Task<CalendarEvent?> CreateEventAsync(DateOnly date)
    {
        var parameters = new DialogParameters<EventEditDialog.EventModel>
        {
            [nameof(EventEditDialog.Date)] = date
        };

        var options = new DialogOptions { CloseButton = true, FullWidth = true };
        var dialog = await Dialog.ShowAsync<EventEditDialog>("Create event", parameters, options);

        DialogResult? result = await dialog.Result;

        if (result is null || result.Canceled || !(result.Data is CustomWorkoutModel model)) return null;

        var nbDaysFromStartDay = date.DayNumber - _planningStartDate.DayNumber;
        var weekNumber = (nbDaysFromStartDay / 7) + 1;
        var id = _planning!.Workouts.Where(x => x.WeekNumber == weekNumber).Max(x => x.Id) + 1;
        var workout = model.ToCustomWorkout(weekNumber, _planning.Athlete, id);
        _planning.BaseWorkouts.Add(workout);

        var planned = WorkoutCreator.Create(workout, _planning.Athlete, date);
        _planning.Workouts.Add(planned);

        StateHasChanged();

        return planned.ToCalendarEvent();
    }
}