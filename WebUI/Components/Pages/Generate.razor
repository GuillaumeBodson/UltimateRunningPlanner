@page "/generate"
@using System.IO.Compression
@using System.Text.Json
@using GarminRunerz.Workout.Models
@using GarminRunerz.Workout.Services
@using GarminRunerz.Workout.Services.Models
@using WebUI.Mappers
@using WebUI.Models
@using MudBlazor
@using Microsoft.JSInterop
@using WebUI.Models.Workouts
@using WebUI.Services
@using WebUI.Services.Interfaces
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject IJSRuntime JS
@rendermode InteractiveServer
@inject IWorkoutGeneratorService WorkoutGeneratorService
@inject IPlanningLoaderService PlanningLoaderService
@inject IWorkoutMetadataFactory WorkoutMetadataFactory
@inject IAthleteSession AthleteSession

<PageTitle>Generate</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="py-6">
    <MudText Typo="Typo.h3" Color="Color.Primary" Class="page-title mb-3">Athlete Management</MudText>
    <MudDivider Class="mb-4" />

    <MudButton Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.Download"
               Disabled="@(!CanDownload)"
               OnClick="DownloadWorkoutsAsync">
        Download workouts
    </MudButton>
</MudContainer>

@code {
    private List<PlannedWorkout>? Workouts { get; set; }
    private bool CanDownload => Workouts is { Count: > 0 } && Athlete is not null;
    private Planning? _planning;
    private Athlete? Athlete { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        _planning = PlanningLoaderService.GetPlanning();
        if (_planning is not null)
        {
            Workouts = _planning.Workouts
                .Where(w => w is StructuredWorkout sw && !sw.IsEmpty)
                .ToList();
        }

        Athlete = await AthleteSession.GetAndSetAsync();
        StateHasChanged();
    }

    private async Task DownloadWorkoutsAsync()
    {
        if (!CanDownload) return;

        using var ms = new MemoryStream();
        using (var archive = new ZipArchive(ms, ZipArchiveMode.Create, leaveOpen: true))
        {
            foreach (PlannedWorkout workout in Workouts!)
            {
                var workoutPreferences = Athlete!.AthletePreferences.GetPreferencesForRunType(workout.RunType);

                var entry = archive.CreateEntry($"w{workout.WeekNumber}-{workout.RunType}.json");
                await using var entryStream = entry.Open();

                var customWorkout = workout.ToCustomWorkout();
                var metadata = WorkoutMetadataFactory.Create(workout, _planning!.Athlete, workoutPreferences);
                Workout garminWorkout = WorkoutGeneratorService.GenerateWorkoutsFromPlanning(customWorkout, metadata);
                await JsonSerializer.SerializeAsync(entryStream, garminWorkout);
            }
        }

        ms.Position = 0;
        using var streamRef = new DotNetStreamReference(ms);
        var module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/download.js");
        var fileName = $"workouts-{DateTime.UtcNow:yyyyMMdd-HHmmss}.zip";
        await module.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }
}
