@using System.MudPlanner
@using GarminRunerz.Workout.Models
@using GarminRunerz.Workout.Services
@using System.Text.Json
@using WebUI.Mappers
@using WebUI.Models
@using WebUI.Models.Workouts
@using MudBlazor
@using WebUI.Services.Interfaces
@inject IJSRuntime JS
@inject IWorkoutMetadataFactory WorkoutMetadataFactory
@inject IWorkoutGeneratorService WorkoutGeneratorService




<MudStack Spacing="1">
    <MudText Typo="Typo.h6">@Event.Title</MudText>
    @if (!string.IsNullOrWhiteSpace(Event.Description))
    {
        <MudText Typo="Typo.body2" Class="text-muted">@Event.Description</MudText>
    }
    <MudChip T="string" Color="@Workout.CalendarColor" Variant="Variant.Filled" Size="Size.Small">@Workout.EventLabel</MudChip>
    <MudText Typo="Typo.body2">
        @Math.Round(Workout.EstimatedDistance / 1000.0, 1) km • @FormatDuration(Workout.EstimatedTime)
    </MudText >
    @if (!Workout.IsEmpty)
    {
        <MudText Typo="Typo.body2">
            @Workout.StringifyDetails()>
        </MudText>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Download"                   
                   OnClick="DownloadWorkoutsAsync">
            Download workout
        </MudButton>
    }
    
</MudStack>

@code {
    [Parameter] public CalendarEvent Event { get; set; } = default!;
    [Parameter] public StructuredWorkout Workout { get; set; } = default!;
    [Parameter] public Athlete Athlete { get; set; } = default!;

    private static string FormatDuration(int seconds)
        => TimeSpan.FromSeconds(seconds).ToString("h\\:mm\\:ss");

    private async Task DownloadWorkoutsAsync()
    {
        var customWorkout = Workout.ToCustomWorkout();
        var workoutPreferences = Athlete!.AthletePreferences.GetPreferencesForRunType(Workout.RunType);

        var metadata = WorkoutMetadataFactory.Create(Workout, Athlete, workoutPreferences);
        Workout garminWorkout = WorkoutGeneratorService.GenerateWorkoutsFromPlanning(customWorkout, metadata);
        var content = JsonSerializer.Serialize(garminWorkout);
        var bytes = System.Text.Encoding.UTF8.GetBytes(content);
        var base64 = Convert.ToBase64String(bytes);
        var module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/download.js");
        var filename = $"w{Workout.WeekNumber}-{Workout.RunType}.json";

        await module.InvokeVoidAsync("downloadFileFromBytes", filename, "application/json", base64);
    }
}