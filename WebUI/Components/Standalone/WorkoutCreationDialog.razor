@using GarminRunerz.Workout.Services.Models
@using MudBlazor
@using System.MudPlanner
@using WebUI.Models.Workouts
@inherits ComponentBase
@namespace BlazorApp.Components


<MudDialog CloseOnEscapeKey="true" MaxWidth="MaxWidth.Small" Position="DialogPosition.Center">
    <DialogContent>
        <MudForm @ref="_form">
            <MudText Typo="Typo.h6" Class="mb-2">New event for @Date.ToString("D")</MudText>

            <MudNumericField @bind-Value="Model.Repetitions" Label="Repetitions" Required="true" Disabled="_isRepetitionDisable" />
            <MudNumericField @bind-Value="Model.RunDuration" Label="Effort duration (s)" Required="true" Disabled="_isRepetitionDisable" />
            <MudNumericField @bind-Value="Model.CoolDownDuration" Label="Cool down duration (s)" Required="true" Disabled="_isRepetitionDisable" />
            <MudNumericField @bind-Value="Model.TotalDuration" Label="Total duration (s)" Required="true"  />

            <MudTextField @bind-Value="Model.Description" Label="Description" Lines="3" />

            <MudSelect T="RunType"  Label="Run Type" ValueChanged="OnRunTypeChanged" Required="true">
                @foreach (var c in Enum.GetValues<RunType>())
                {
                    <MudSelectItem Value="c">@c</MudSelectItem>
                }
            </MudSelect>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Default">Cancel</MudButton>
        <MudButton OnClick="Save" Color="Color.Primary" Variant="Variant.Filled">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public DateOnly Date { get; set; }

    private MudForm? _form;
    [Parameter] public CustomWorkoutModel Model { get; set; } = new() { RunType = RunType.Easy };
    private bool _isRepetitionDisable = true;

    private async Task Save()
    {
        if (_form is null) return;
        await _form.Validate();
        if (_form.IsValid)
            MudDialog.Close(DialogResult.Ok(Model));
    }

    private void Cancel() => MudDialog.Cancel();

    private void OnRunTypeChanged(RunType args)
    {
        Model.RunType = args;
        if ((args & (RunType.Easy | RunType.Race | RunType.Recovery)) !=0)
        {
            Model.Repetitions = 0;
            Model.RunDuration = 0;
            Model.CoolDownDuration = 0;
            _isRepetitionDisable = true;
        }
        else
        {
            _isRepetitionDisable = false;
        }
    }
}